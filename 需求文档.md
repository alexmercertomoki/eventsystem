我来帮您编写一份基于TDD的技术开发文档，聚焦于第一版最基本的MVP功能。

# 活动平台 MVP 技术开发文档（TDD v1.0）

## 一、MVP v1.0 范围定义

### 核心功能（第一版）
1. **管理员系统**
   - 初始超级管理员（通过种子数据创建）
   - 管理员可添加其他管理员
   - 管理员登录认证

2. **活动发布**
   - 创建/编辑活动基本信息
   - Canvas内容编辑器（支持文本和图片）
   - 活动列表展示
   - 活动详情页

### 暂不实现（后续版本）
- 用户注册审核系统
- 活动报名功能
- 评论系统
- 数据导出
- 邮件通知

## 二、技术栈选型

```yaml
Frontend:
  - Next.js 14 (App Router)
  - TypeScript
  - Tailwind CSS
  - shadcn/ui
  - TanStack Query (数据获取)
  - Zustand (状态管理)

Backend:
  - Node.js + Express
  - TypeScript
  - Prisma ORM
  - PostgreSQL
  - JWT (认证)
  - Zod (验证)

Development:
  - Jest (单元测试)
  - Supertest (API测试)
  - Playwright (E2E测试)
```

## 三、数据库设计

```prisma
// schema.prisma

model Admin {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String    // bcrypt hashed
  name          String
  role          Role      @default(ADMIN)
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  createdBy     String?   // 创建者的Admin ID
  
  events        Event[]
  contentBlocks ContentBlock[]
}

enum Role {
  SUPER_ADMIN
  ADMIN
}

model Event {
  id            String    @id @default(cuid())
  title         String
  slug          String    @unique
  description   String?
  coverImage    String?
  startTime     DateTime
  endTime       DateTime
  location      String?
  status        EventStatus @default(DRAFT)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  publishedAt   DateTime?
  
  createdBy     String
  admin         Admin     @relation(fields: [createdBy], references: [id])
  contentBlocks ContentBlock[]
  
  @@index([status, startTime])
  @@index([slug])
}

enum EventStatus {
  DRAFT
  PUBLISHED
  CANCELLED
}

model ContentBlock {
  id          String   @id @default(cuid())
  eventId     String
  type        BlockType
  content     Json     // 存储具体内容
  orderIndex  Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  event       Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  createdBy   String
  admin       Admin    @relation(fields: [createdBy], references: [id])
  
  @@unique([eventId, orderIndex])
  @@index([eventId])
}

enum BlockType {
  TEXT
  IMAGE
}
```

## 四、API 设计

### 认证相关

```typescript
// POST /api/auth/login
interface LoginRequest {
  email: string;
  password: string;
}

interface LoginResponse {
  token: string;
  admin: {
    id: string;
    email: string;
    name: string;
    role: 'SUPER_ADMIN' | 'ADMIN';
  };
}

// GET /api/auth/me
interface MeResponse {
  id: string;
  email: string;
  name: string;
  role: string;
}
```

### 管理员管理

```typescript
// POST /api/admin/users (仅SUPER_ADMIN)
interface CreateAdminRequest {
  email: string;
  password: string;
  name: string;
}

// GET /api/admin/users
interface AdminListResponse {
  admins: Array<{
    id: string;
    email: string;
    name: string;
    role: string;
    isActive: boolean;
    createdAt: string;
  }>;
  total: number;
}
```

### 活动管理

```typescript
// POST /api/admin/events
interface CreateEventRequest {
  title: string;
  slug: string;
  description?: string;
  coverImage?: string;
  startTime: string; // ISO 8601
  endTime: string;
  location?: string;
}

// PUT /api/admin/events/:id
interface UpdateEventRequest extends CreateEventRequest {
  status?: 'DRAFT' | 'PUBLISHED' | 'CANCELLED';
}

// GET /api/events (公开接口)
interface EventListResponse {
  events: Array<{
    id: string;
    title: string;
    slug: string;
    coverImage?: string;
    startTime: string;
    endTime: string;
    location?: string;
    status: string;
  }>;
  pagination: {
    page: number;
    limit: number;
    total: number;
  };
}
```

### Canvas 内容块

```typescript
// PUT /api/admin/events/:id/content-blocks
interface UpdateContentBlocksRequest {
  blocks: Array<{
    type: 'TEXT' | 'IMAGE';
    content: {
      // TEXT类型
      text?: string;
      style?: {
        fontSize?: string;
        fontWeight?: string;
        textAlign?: string;
      };
      // IMAGE类型
      url?: string;
      alt?: string;
      caption?: string;
    };
    orderIndex: number;
  }>;
}

// GET /api/events/:slug/content
interface EventContentResponse {
  event: {
    id: string;
    title: string;
    description: string;
    // ...
  };
  blocks: Array<{
    id: string;
    type: string;
    content: any;
    orderIndex: number;
  }>;
}
```

## 五、测试策略（TDD）

### 1. 单元测试示例

```typescript
// tests/unit/auth.test.ts
describe('Auth Service', () => {
  describe('login', () => {
    it('should return JWT token for valid credentials', async () => {
      const result = await authService.login('admin@example.com', 'password');
      expect(result.token).toBeDefined();
      expect(jwt.verify(result.token, process.env.JWT_SECRET)).toBeTruthy();
    });

    it('should throw error for invalid credentials', async () => {
      await expect(
        authService.login('admin@example.com', 'wrong')
      ).rejects.toThrow('Invalid credentials');
    });
  });
});
```

### 2. API集成测试

```typescript
// tests/api/events.test.ts
describe('Events API', () => {
  let authToken: string;

  beforeAll(async () => {
    // Setup test database and get auth token
    authToken = await getTestAuthToken();
  });

  describe('POST /api/admin/events', () => {
    it('should create event with valid data', async () => {
      const response = await request(app)
        .post('/api/admin/events')
        .set('Authorization', `Bearer ${authToken}`)
        .send({
          title: 'Test Event',
          slug: 'test-event',
          startTime: '2024-02-01T10:00:00Z',
          endTime: '2024-02-01T12:00:00Z'
        });

      expect(response.status).toBe(201);
      expect(response.body.event.title).toBe('Test Event');
    });

    it('should reject duplicate slug', async () => {
      // First create
      await request(app)
        .post('/api/admin/events')
        .set('Authorization', `Bearer ${authToken}`)
        .send({ slug: 'duplicate-test', /* ... */ });

      // Try duplicate
      const response = await request(app)
        .post('/api/admin/events')
        .set('Authorization', `Bearer ${authToken}`)
        .send({ slug: 'duplicate-test', /* ... */ });

      expect(response.status).toBe(400);
      expect(response.body.error).toContain('slug already exists');
    });
  });
});
```

### 3. Canvas 内容编辑器测试

```typescript
// tests/api/canvas.test.ts
describe('Canvas Content Blocks', () => {
  describe('PUT /api/admin/events/:id/content-blocks', () => {
    it('should update content blocks atomically', async () => {
      const eventId = await createTestEvent();
      
      const blocks = [
        {
          type: 'TEXT',
          content: { text: 'Welcome to our event!' },
          orderIndex: 0
        },
        {
          type: 'IMAGE',
          content: { 
            url: 'https://example.com/image.jpg',
            alt: 'Event banner'
          },
          orderIndex: 1
        }
      ];

      const response = await request(app)
        .put(`/api/admin/events/${eventId}/content-blocks`)
        .set('Authorization', `Bearer ${authToken}`)
        .send({ blocks });

      expect(response.status).toBe(200);
      expect(response.body.blocks).toHaveLength(2);
    });

    it('should sanitize HTML in text blocks', async () => {
      const eventId = await createTestEvent();
      
      const response = await request(app)
        .put(`/api/admin/events/${eventId}/content-blocks`)
        .set('Authorization', `Bearer ${authToken}`)
        .send({
          blocks: [{
            type: 'TEXT',
            content: { 
              text: '<script>alert("XSS")</script><p>Safe text</p>'
            },
            orderIndex: 0
          }]
        });

      expect(response.body.blocks[0].content.text).toBe('<p>Safe text</p>');
    });
  });
});
```

## 六、安全实现

### 1. 认证中间件

```typescript
// middleware/auth.ts
export const authenticate = async (req: Request, res: Response, next: NextFunction) => {
  try {
    const token = req.headers.authorization?.replace('Bearer ', '');
    if (!token) throw new Error('No token');

    const decoded = jwt.verify(token, process.env.JWT_SECRET) as JWTPayload;
    const admin = await prisma.admin.findUnique({
      where: { id: decoded.adminId, isActive: true }
    });

    if (!admin) throw new Error('Admin not found');

    req.admin = admin;
    next();
  } catch (error) {
    res.status(401).json({ error: 'Unauthorized' });
  }
};

export const requireSuperAdmin = async (req: Request, res: Response, next: NextFunction) => {
  if (req.admin?.role !== 'SUPER_ADMIN') {
    return res.status(403).json({ error: 'Forbidden' });
  }
  next();
};
```

### 2. 输入验证

```typescript
// validation/event.ts
import { z } from 'zod';

export const createEventSchema = z.object({
  title: z.string().min(1).max(200),
  slug: z.string().regex(/^[a-z0-9-]+$/),
  description: z.string().max(1000).optional(),
  coverImage: z.string().url().optional(),
  startTime: z.string().datetime(),
  endTime: z.string().datetime(),
  location: z.string().max(200).optional()
}).refine(data => new Date(data.endTime) > new Date(data.startTime), {
  message: "End time must be after start time"
});

export const contentBlockSchema = z.object({
  type: z.enum(['TEXT', 'IMAGE']),
  content: z.object({
    text: z.string().optional(),
    url: z.string().url().optional(),
    alt: z.string().optional(),
    caption: z.string().optional()
  }),
  orderIndex: z.number().int().min(0)
});
```

### 3. HTML清洗

```typescript
// utils/sanitize.ts
import sanitizeHtml from 'sanitize-html';

export const sanitizeContent = (html: string): string => {
  return sanitizeHtml(html, {
    allowedTags: ['p', 'br', 'strong', 'em', 'u', 'h1', 'h2', 'h3', 'ul', 'ol', 'li', 'a'],
    allowedAttributes: {
      'a': ['href', 'target']
    },
    allowedSchemes: ['http', 'https']
  });
};

export const validateImageUrl = (url: string): boolean => {
  const allowedDomains = process.env.ALLOWED_IMAGE_DOMAINS?.split(',') || [];
  try {
    const urlObj = new URL(url);
    return allowedDomains.some(domain => urlObj.hostname.endsWith(domain));
  } catch {
    return false;
  }
};
```

## 七、项目结构

```
project/
├── packages/
│   ├── web/                 # Next.js前端
│   │   ├── app/
│   │   │   ├── (public)/
│   │   │   │   ├── events/
│   │   │   │   └── page.tsx
│   │   │   ├── admin/
│   │   │   │   ├── events/
│   │   │   │   ├── users/
│   │   │   │   └── layout.tsx
│   │   │   └── api/
│   │   ├── components/
│   │   │   ├── canvas/
│   │   │   │   ├── Editor.tsx
│   │   │   │   ├── TextBlock.tsx
│   │   │   │   └── ImageBlock.tsx
│   │   │   └── ui/
│   │   └── lib/
│   │       ├── api-client.ts
│   │       └── auth.ts
│   │
│   └── server/              # Express后端
│       ├── src/
│       │   ├── routes/
│       │   │   ├── auth.ts
│       │   │   ├── admin.ts
│       │   │   └── events.ts
│       │   ├── services/
│       │   ├── middleware/
│       │   ├── utils/
│       │   └── index.ts
│       ├── prisma/
│       │   ├── schema.prisma
│       │   └── seed.ts
│       └── tests/
│
├── docker-compose.yml       # 本地开发环境
├── .env.example
└── package.json
```

## 八、开发步骤（TDD流程）

### Week 1: 基础设施 + 管理员系统

**Day 1-2: 项目初始化**
1. ✅ 编写数据库schema测试
2. ✅ 实现Prisma schema
3. ✅ 编写种子数据测试
4. ✅ 实现seed脚本创建超级管理员

**Day 3-4: 认证系统**
1. ✅ 编写登录API测试
2. ✅ 实现JWT认证
3. ✅ 编写认证中间件测试
4. ✅ 实现中间件

**Day 5: 管理员管理**
1. ✅ 编写创建管理员API测试
2. ✅ 实现权限控制
3. ✅ 编写管理员列表测试
4. ✅ 实现列表接口

### Week 2: 活动系统 + Canvas编辑器

**Day 6-7: 活动CRUD**
1. ✅ 编写活动创建测试
2. ✅ 实现创建接口
3. ✅ 编写更新/删除测试
4. ✅ 实现完整CRUD

**Day 8-10: Canvas编辑器**
1. ✅ 编写内容块更新测试
2. ✅ 实现事务化更新
3. ✅ 编写HTML清洗测试
4. ✅ 实现安全过滤
5. ✅ 编写前端组件测试
6. ✅ 实现拖拽排序

## 九、部署配置

### 环境变量

```env
# .env.example
DATABASE_URL=postgresql://user:password@localhost:5432/events
JWT_SECRET=your-secret-key
ALLOWED_IMAGE_DOMAINS=s3.amazonaws.com,cdn.example.com
PORT=3001
```

### Docker Compose (开发环境)

```yaml
# docker-compose.yml
version: '3.8'
services:
  postgres:
    image: postgres:15
    environment:
      POSTGRES_DB: events_dev
      POSTGRES_USER: dev
      POSTGRES_PASSWORD: dev123
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:7
    ports:
      - "6379:6379"

volumes:
  postgres_data:
```

## 十、监控与日志

```typescript
// middleware/logging.ts
export const requestLogger = (req: Request, res: Response, next: NextFunction) => {
  const start = Date.now();
  
  res.on('finish', () => {
    logger.info({
      method: req.method,
      url: req.url,
      status: res.statusCode,
      duration: Date.now() - start,
      adminId: req.admin?.id
    });
  });
  
  next();
};
```
